@page "/app"
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject HttpClient _client

<div class="app-page">
    <div class="navbar">
        <h1>ToDo App</h1>

        <div class="nav-items">
            <button class="nav-button" @onclick="AddCategory">Dodaj nową kategorię</button>
            <button class="nav-button" type="button">Moje konto</button>
            <button class="nav-button" @onclick="Logout" type="button">Wyloguj</button>
        </div>
    </div>

    <div class="content">
        <div class="categories-panel">
            @foreach (var category in categories)
            {
                <div class="category-card">
                    <div class="category-header">
                        <span class="category-name">@category.Name</span>
                        <div class="category-buttons">
                            <button class="add-task-button" @onclick="() => AddTask(category.Id)">Nowe zadanie</button>
                            <button class="edit-category-button" @onclick="() => EditCategory(category.Id)">Edytuj</button>
                        </div>
                    </div>

                    <div class="tasks-list">
                        @foreach (var task in category.Tasks)
                        {
                            <div class="task-card" @onclick="() => OpenTask(task)">
                                @task.Title
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@if (showAddCategoryModal)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2>Dodaj nową kategorię</h2>

            <EditForm Model="this" OnValidSubmit="SubmitAddCategory">
                <div class="form-group">
                    <label>Nazwa kategorii</label>
                    <InputText @bind-Value="newCategoryName" class="form-control" />
                </div>

                @if (!string.IsNullOrEmpty(categoryError))
                {
                    <p class="app-error">@categoryError</p>
                }

                <button type="submit" class="modal-button">Dodaj</button>
                <button type="button" class="modal-button cancel" @onclick="CloseModal">Anuluj</button>
            </EditForm>
        </div>
    </div>
}

@if (showEditCategoryModal)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2>Edytuj kategorię</h2>

            <EditForm Model="this" OnValidSubmit="SubmitEditCategory">
                <div class="form-group">
                    <label>Nazwa kategorii</label>
                    <InputText @bind-Value="editCategoryName" class="form-control" />
                </div>

                @if (!string.IsNullOrEmpty(categoryError))
                {
                    <p class="app-error">@categoryError</p>
                }

                <button type="submit" class="modal-button">Zapisz zmiany</button>
                <button type="button" class="modal-button delete" @onclick="DeleteCategory">Usuń kategorię</button>
                <button type="button" class="modal-button cancel" @onclick="CloseModal">Anuluj</button>
            </EditForm>
        </div>
    </div>
}

@code
{
    internal class CategoryWithTasksModel : CategoryModel
    {
        public List<TaskModel> Tasks { get; set; } = new();
    }

    private bool isLogged;
    private bool showAddCategoryModal = false;
    private bool showEditCategoryModal = false;
    private int editingCategoryId = 0;
    private string newCategoryName = string.Empty;
    private string editCategoryName = string.Empty;
    private string categoryError = string.Empty;
    private List<CategoryWithTasksModel> categories = new();

    protected override async Task OnInitializedAsync()
    {
        isLogged = await AuthService.IsLoggedAsync();

        if (!isLogged)
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            await LoadCategories();
        }
    }

    private async Task LoadCategories()
    {
        await AuthService.RestoreLoginAsync(_client);

        try
        {
            categories = await _client.GetFromJsonAsync<List<CategoryWithTasksModel>>("/category") ?? new();
            await LoadTasksForCategories();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Błąd podczas ładowania kategorii: " + ex.Message);
        }
    }

    private async Task LoadTasksForCategories()
    {
        foreach (var category in categories)
        {
            try
            {
                var tasks = await _client.GetFromJsonAsync<List<TaskModel>>($"/task?catId={category.Id}");
                category.Tasks = tasks ?? new List<TaskModel>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Błąd podczas ładowania tasków dla kategorii {category.Id}: {ex.Message}");
            }
        }
    }

    private async Task SubmitAddCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategoryName))
        {
            categoryError = "Nazwa kategorii nie może być pusta!";
            return;
        }

        try
        {
            var response = await _client.PostAsync($"/category?name={Uri.EscapeDataString(newCategoryName)}", null);

            if (!response.IsSuccessStatusCode)
            {
                categoryError = "Ta nazwa kategorii już istnieje!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            categoryError = "Wystąpił błąd podczas dodawania kategorii!";
        }
    }

    private async Task SubmitEditCategory()
    {
        if (string.IsNullOrWhiteSpace(editCategoryName))
        {
            categoryError = "Nazwa kategorii nie może być pusta!";
            return;
        }

        try
        {
            var categoryToUpdate = new { Id = editingCategoryId, Name = editCategoryName };
            var json = JsonSerializer.Serialize(categoryToUpdate);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _client.PutAsync("/category", content);

            if (!response.IsSuccessStatusCode)
            {
                categoryError = "Ta nazwa kategorii już istnieje!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            categoryError = "Wystąpił błąd podczas edycji kategorii!";
        }
    }

    private async Task DeleteCategory()
    {
        try
        {
            var response = await _client.DeleteAsync($"/category?id={editingCategoryId}");

            if (!response.IsSuccessStatusCode)
            {
                categoryError = "Kategoria nie istnieje!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            categoryError = "Nie udało się usunąć kategorii!";
        }
    }


    private void AddCategory()
    {
        categoryError = string.Empty;
        newCategoryName = string.Empty;
        showAddCategoryModal = true;
    }

    private void EditCategory(int categoryId)
    {
        var category = categories.FirstOrDefault(c => c.Id == categoryId);
        if (category != null)
        {
            categoryError = string.Empty;
            editCategoryName = category.Name;
            editingCategoryId = categoryId;
            showEditCategoryModal = true;
        }
    }

    private void AddTask(int categoryId)
    {
    }

    private void OpenTask(TaskModel task)
    {
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        NavigationManager.NavigateTo("/");
    }

    private void CloseModal()
    {
        showAddCategoryModal = false;
        showEditCategoryModal = false;
        categoryError = string.Empty;
    }
}