@page "/app"
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject HttpClient _client

<div class="app-page">
    <div class="navbar">
        <h1>ToDo App</h1>

        <div class="nav-items">
            <button class="nav-button" @onclick="AddCategory">Dodaj nową kategorię</button>
            <button class="nav-button" @onclick="EditUser">Moje konto</button>
            <button class="nav-button" @onclick="LogoutAsync">Wyloguj</button>
        </div>
    </div>

    <div class="content">
        <div class="categories-panel">
            @foreach (var category in categories)
            {
                <div class="category-card">
                    <div class="category-header">
                        <span class="category-name">@category.Name</span>
                        <div class="category-buttons">
                            <button class="add-task-button" @onclick="() => AddTask(category.Id)">Nowe zadanie</button>
                            <button class="edit-category-button" @onclick="() => EditCategory(category.Id)">Edytuj</button>
                        </div>
                    </div>

                    <div class="tasks-list">
                        @foreach (var task in category.Tasks)
                        {
                            <div class="task-card" @onclick="() => OpenTask(task)">
                                @task.Title
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@if (showAddCategoryModal)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2>Dodaj nową kategorię</h2>

            <EditForm Model="this" OnValidSubmit="SubmitAddCategory">
                <div class="form-group">
                    <label>Nazwa kategorii</label>
                    <InputText @bind-Value="newCategoryName" class="form-control" />
                </div>

                @if (!string.IsNullOrEmpty(categoryError))
                {
                    <p class="app-error">@categoryError</p>
                }

                <button type="submit" class="modal-button">Dodaj</button>
                <button type="button" class="modal-button cancel" @onclick="CloseModal">Anuluj</button>
            </EditForm>
        </div>
    </div>
}

@if (showEditCategoryModal)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2>Edytuj kategorię</h2>

            <EditForm Model="this" OnValidSubmit="SubmitEditCategory">
                <div class="form-group">
                    <label>Nazwa kategorii</label>
                    <InputText @bind-Value="editCategoryName" class="form-control" />
                </div>

                @if (!string.IsNullOrEmpty(categoryError))
                {
                    <p class="app-error">@categoryError</p>
                }

                <button type="submit" class="modal-button">Zapisz zmiany</button>
                <button type="button" class="modal-button delete" @onclick="DeleteCategory">Usuń kategorię</button>
                <button type="button" class="modal-button cancel" @onclick="CloseModal">Anuluj</button>
            </EditForm>
        </div>
    </div>
}

@if (showAddTaskModal)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2>Nowe zadanie</h2>

            <EditForm Model="editingTask" OnValidSubmit="SubmitAddTask">
                <div class="form-group">
                    <label>Tytuł</label>
                    <InputText @bind-Value="editingTask.Title" />
                </div>

                <div class="form-group">
                    <label>Opis</label>
                    <InputTextArea @bind-Value="editingTask.Description" rows="4" />
                </div>

                @if (!string.IsNullOrEmpty(taskError))
                {
                    <p class="app-error">@taskError</p>
                }

                <button class="modal-button" type="submit">Dodaj</button>
                <button class="modal-button cancel" type="button" @onclick="CloseModal">Anuluj</button>
            </EditForm>
        </div>
    </div>
}

@if (showEditTaskModal)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2>Edycja zadania</h2>

            <EditForm Model="editingTask" OnValidSubmit="SubmitEditTask">
                <div class="form-group">
                    <label>Tytuł</label>
                    <InputText @bind-Value="editingTask.Title" />
                </div>

                <div class="form-group">
                    <label>Opis</label>
                    <InputTextArea @bind-Value="editingTask.Description" rows="4" />
                </div>

                <div class="form-group">
                    <label>Kategoria</label>
                    <select @bind="editingTask.IdCategory">
                        @foreach (var cat in categories)
                        {
                            <option value="@cat.Id">@cat.Name</option>
                        }
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(taskError))
                {
                    <p class="app-error">@taskError</p>
                }

                <button class="modal-button" type="submit">Zapisz</button>
                <button class="modal-button delete" type="button" @onclick="DeleteTask">Usuń</button>
                <button class="modal-button cancel" type="button" @onclick="CloseModal">Anuluj</button>
            </EditForm>
        </div>
    </div>
}

@if (showUserModal)
{
    <div class="modal-backdrop">
        <div class="modal-card">
            <h2>Moje konto - @user.Username</h2>

            <EditForm Model="this" OnValidSubmit="ChangePassword">
                <div class="form-group">
                    <label>Nowe hasło</label>
                    <InputText type="password" @bind-Value="newPassword" />
                </div>

                @if (!string.IsNullOrEmpty(userError))
                {
                    <p class="app-error">@userError</p>
                }

                @if (!string.IsNullOrEmpty(userSuccess))
                {
                    <p class="app-success">@userSuccess</p>
                }

                <button class="modal-button" type="submit">Zmień hasło</button>
            </EditForm>

            <button class="modal-button delete" @onclick="DeleteUser">Usuń konto</button>

            <button class="modal-button cancel" @onclick="CloseModal">Zamknij</button>
        </div>
    </div>
}

@code
{
    internal class CategoryWithTasksModel : CategoryModel
    {
        public List<TaskModel> Tasks { get; set; } = new();
    }

    private bool isLogged;

    private bool showAddCategoryModal = false;
    private bool showEditCategoryModal = false;
    private bool showAddTaskModal = false;
    private bool showEditTaskModal = false;
    private bool showUserModal = false;

    private int editingCategoryId = 0;
    private string newCategoryName = string.Empty;
    private string editCategoryName = string.Empty;
    private string newPassword = string.Empty;

    private string categoryError = string.Empty;
    private string taskError = string.Empty;
    private string userError = string.Empty;
    private string userSuccess = string.Empty;

    private List<CategoryWithTasksModel> categories = new();
    private UserModel user = new();
    private TaskModel editingTask = new();

    protected override async Task OnInitializedAsync()
    {
        isLogged = await AuthService.IsLoggedAsync();
        user = await AuthService.GetLoggedUserAsync();

        if (!isLogged)
        {
            NavigationManager.NavigateTo("/");
        }
        else
        {
            await LoadCategories();
        }
    }

    private async Task LoadCategories()
    {
        await AuthService.RestoreLoginAsync(_client);

        try
        {
            categories = await _client.GetFromJsonAsync<List<CategoryWithTasksModel>>("/category") ?? new();
            await LoadTasksForCategories();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Błąd podczas ładowania kategorii: " + ex.Message);
        }
    }

    private async Task LoadTasksForCategories()
    {
        foreach (var category in categories)
        {
            try
            {
                var tasks = await _client.GetFromJsonAsync<List<TaskModel>>($"/task?catId={category.Id}");
                category.Tasks = tasks ?? new List<TaskModel>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Błąd podczas ładowania tasków dla kategorii {category.Id}: {ex.Message}");
            }
        }
    }

    private async Task SubmitAddCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategoryName))
        {
            categoryError = "Nazwa kategorii nie może być pusta!";
            return;
        }

        try
        {
            var response = await _client.PostAsync($"/category?name={Uri.EscapeDataString(newCategoryName)}", null);

            if (!response.IsSuccessStatusCode)
            {
                categoryError = "Ta nazwa kategorii już istnieje!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            categoryError = "Wystąpił błąd podczas dodawania kategorii!";
        }
    }

    private async Task SubmitEditCategory()
    {
        if (string.IsNullOrWhiteSpace(editCategoryName))
        {
            categoryError = "Nazwa kategorii nie może być pusta!";
            return;
        }

        try
        {
            var categoryToUpdate = new { Id = editingCategoryId, Name = editCategoryName };
            var json = JsonSerializer.Serialize(categoryToUpdate);
            var content = new StringContent(json, Encoding.UTF8, "application/json");

            var response = await _client.PutAsync("/category", content);

            if (!response.IsSuccessStatusCode)
            {
                categoryError = "Ta nazwa kategorii już istnieje!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            categoryError = "Wystąpił błąd podczas edycji kategorii!";
        }
    }

    private async Task DeleteCategory()
    {
        try
        {
            var response = await _client.DeleteAsync($"/category?id={editingCategoryId}");

            if (!response.IsSuccessStatusCode)
            {
                categoryError = "Kategoria nie istnieje!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            categoryError = "Nie udało się usunąć kategorii!";
        }
    }

    private async Task SubmitAddTask()
    {
        if (string.IsNullOrWhiteSpace(editingTask.Title))
        {
            taskError = "Tytuł jest wymagany!";
            return;
        }

        try
        {
            var response = await _client.PostAsJsonAsync("/task", editingTask);

            if (!response.IsSuccessStatusCode)
            {
                taskError = "Nie udało się dodać zadania!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            taskError = "Błąd serwera!";
        }
    }

    private async Task SubmitEditTask()
    {
        try
        {
            var response = await _client.PutAsJsonAsync("/task", editingTask);

            if (!response.IsSuccessStatusCode)
            {
                taskError = "Nie udało się zapisać zmian!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            taskError = "Błąd edycji zadania!";
        }
    }

    private async Task DeleteTask()
    {
        try
        {
            var response = await _client.DeleteAsync($"/task/{editingTask.Id}");

            if (!response.IsSuccessStatusCode)
            {
                taskError = "Nie udało się usunąć zadania!";
                return;
            }

            await LoadCategories();
            CloseModal();
        }
        catch
        {
            taskError = "Błąd usuwania zadania!";
        }
    }

    private async Task ChangePassword()
    {
        if (string.IsNullOrWhiteSpace(newPassword))
        {
            userError = "Hasło nie może być puste!";
            return;
        }

        try
        {
            var response = await _client.PutAsync($"/user/{user.Username}?password={Uri.EscapeDataString(newPassword)}", null);

            if (!response.IsSuccessStatusCode)
            {
                userError = "Nie udało się zmienić hasła!";
                return;
            }

            userSuccess = "Hasło zostało zmienione!";
            newPassword = string.Empty;
        }
        catch
        {
            userError = "Wystąpił błąd podczas zmiany hasła!";
        }
    }

    private async Task DeleteUser()
    {
        try
        {
            var response = await _client.DeleteAsync($"/user/{user.Username}");

            if (!response.IsSuccessStatusCode)
            {
                userError = "Nie udało się usunąć konta!";
                return;
            }

            await LogoutAsync();
            NavigationManager.NavigateTo("/");
        }
        catch
        {
            userError = "Wystąpił błąd poczas usuwania konta!";
        }
    }

    private void AddCategory()
    {
        categoryError = string.Empty;
        newCategoryName = string.Empty;
        showAddCategoryModal = true;
    }

    private void EditCategory(int categoryId)
    {
        var category = categories.FirstOrDefault(c => c.Id == categoryId);
        if (category != null)
        {
            categoryError = string.Empty;
            editCategoryName = category.Name;
            editingCategoryId = categoryId;
            showEditCategoryModal = true;
        }
    }

    private void AddTask(int categoryId)
    {
        taskError = string.Empty;
        editingCategoryId = categoryId;

        editingTask = new TaskModel
        {
            IdCategory = categoryId
        };

        showAddTaskModal = true;
    }

    private void OpenTask(TaskModel task)
    {
        taskError = string.Empty;
        editingTask = new TaskModel
        {
            Id = task.Id,
            Title = task.Title,
            Description = task.Description,
            IdCategory = task.IdCategory
        };

        showEditTaskModal = true;
    }

    private void EditUser()
    {
        userError = string.Empty;
        newPassword = string.Empty;
        showUserModal = true;
    }

    private async Task LogoutAsync()
    {
        await AuthService.LogoutAsync();
        NavigationManager.NavigateTo("/");
    }

    private void CloseModal()
    {
        showAddCategoryModal = false;
        showEditCategoryModal = false;
        showAddTaskModal = false;
        showEditTaskModal = false;
        showUserModal = false;

        categoryError = string.Empty;
        taskError = string.Empty;
        userError = string.Empty;
        userSuccess = string.Empty;
    }
}